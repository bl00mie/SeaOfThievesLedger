<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Sea of Thieves Faction Ledger Info</title>
    <style>
        /* set the CSS */

        body {
            font: 12px Arial;
            background-color: #355553;
        }

        path {
            stroke: steelblue;
            stroke-width: 2;
            fill: none;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: grey;
            stroke-width: 1;
            shape-rendering: crispEdges;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.5.0.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script>
        // library functions
        var getSeason = function (date) {
            // javascript Date.getMonth() is STUPID, and returns the 0-based index of the month rather than the month,
            // so checking for "Is it April?" means checking if getMonth() == 3
            // NOTE: If we're in April 2020, the season is actually part of the May 2020 season, so "202005". Otherwise it's
            // just yyyyMM for whatever month you're in.
            if (date.getUTCMonth() == 3 && date.getUTCFullYear() == 2020) {
                date.setMonth(4);
            }
            var currentSeason = d3.timeFormat("%Y%m")(date);
            return currentSeason;
        };

        var hashParams = null;
        var hashParam = function (name) {
            if (!hashParams) {
                hashParams = {};
                document.location.hash.substring(1).split("&").forEach(function (paramStr) {
                    var kvp = paramStr.split("=");
                    hashParams[kvp[0]] = kvp[1];
                });
            }
            return hashParams[name];
        };

        var param = function (name) {
            if (name = (new RegExp('[?&]' + encodeURIComponent(name) + '=([^&]*)')).exec(location.search))
                return decodeURIComponent(name[1]);
        };

        // constants
        const API_URL = "http://sotledger.azurewebsites.net/api/";
        const USER_URL = API_URL + "user/";
        const LEDGER_URL = API_URL + "ledger";
        const FACTIONS = {
            "af": {
                name: "Athena's Fortune",
                rgb: d3.rgb("#91E6CB")
            },
            "gh": {
                name: "Gold Hoarders",
                rgb: d3.rgb("#C3922E")
            },
            "ma": {
                name: "Merchant Alliance",
                rgb: d3.rgb("#9599B3")
            },
            "os": {
                name: "Order of Souls",
                rgb: d3.rgb("#764B74")
            },
            "rb": {
                name: "Reapers Bones",
                rgb: d3.rgb("#B13314")
            }
        };

        // global variables
        var seasonData = { y: "Top Quartile Cut-offs", factions: [], dates: [] };
        var userData = {};
        var season = hashParam("season") || getSeason(new Date());
        var users = [];
        if (hashParam("users"))
            users = hashParam("users").split(",");

        var refreshData = function () {
            $.ajax({
                async: true,
                type: "GET",
                url: LEDGER_URL + "?season=" + season,
                headers: {
                    Accept: "application/json"
                },
                success: function (data) {
                    seasonData.minScore = Number.MAX_VALUE;
                    seasonData.maxScore = 0;
                    seasonData.factions = [];
                    let rowKeys = Object.keys(data.entries).sort();
                    Object.keys(FACTIONS).forEach(function (facKey) {
                        let facData = {
                            name: FACTIONS[facKey].name,
                            rgb: FACTIONS[facKey].rgb,
                            values: []
                        };
                        rowKeys.forEach(function (rowKey) {
                            let val = data.entries[rowKey][facKey + "_0_lo_score"];
                            if (val < seasonData.minScore) seasonData.minScore = val;
                            if (val > seasonData.maxScore) seasonData.maxScore = val;
                            facData.values.push(val);
                        });
                        seasonData.factions.push(facData);
                    });

                    seasonData.dates = rowKeys.map(d3.timeParse("faction-%Y%m%d-%H"));

                    console.log(seasonData);
                    chart();
                }
            });
        };

        var refreshUserData = function () {
            users.forEach(function (user) {
                if (user) {
                    $.ajax({
                        async: true,
                        type: "GET",
                        url: USER_URL + user + "?season=" + season,
                        headers: {
                            Accept: "application/json"
                        },
                        success: function (data) {
                            var keys = Object.keys(data.entries).sort();
                            var last = data.entries[keys[keys.length - 1]];
                            userData[user] = {};
                            Object.keys(FACTIONS).forEach(function (facKey) {
                                userData[user][facKey] = last[facKey + "_score"];
                            });
                            console.log(userData);
                        }
                    });
                }
            });
        };



        var margin = { top: 30, right: 20, bottom: 30, left: 100 },
            width = 900 - margin.left - margin.right,
            height = 600 - margin.top - margin.bottom;

        var x = d3.scaleTime().range([0, width]);
        var y = d3.scaleLinear().range([height, 0]);

        var xAxis = d3.axisBottom().scale(x).ticks(5);

        var yAxis = d3.axisLeft().scale(y).ticks(5);

        var scoreline = d3.line()
            .x(function (d, i) { return x(seasonData.dates[i]); })
            .y(function (d) { return y(d); });

        var svg = null;

        var chart = function () {
            x.domain(d3.extent(seasonData.dates, function (d) { return d; }));
            y.domain([seasonData.minScore, seasonData.maxScore]);

            seasonData.factions.forEach(function (faction) {
                svg.append("path")
                    .attr("class", "line")
                    .style("stroke", faction.rgb)
                    .attr("d", scoreline(faction.values));
            });

            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis);
            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis);

        };

        $(document).ready(function () {
            svg = d3.select("body")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
            refreshData();
            refreshUserData();
        });
    </script>
</head>
<body></body>
</html>