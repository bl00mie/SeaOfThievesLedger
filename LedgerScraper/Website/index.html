<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Sea of Thieves Faction Ledger Info</title>
    <style>
        /* set the CSS */

        body {
            font: 12px Arial;
            background-color: #355553;
        }

        path {
            stroke: steelblue;
            stroke-width: 2;
            fill: none;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: grey;
            stroke-width: 1;
            shape-rendering: crispEdges;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.5.0.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script>
        // Hard Coded external libraries:

        /*! jquery-dateformat 01-08-2019 */
        var DateFormat = {}; !function (e) { var I = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"], O = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"], v = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"], w = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"], a = { Jan: "01", Feb: "02", Mar: "03", Apr: "04", May: "05", Jun: "06", Jul: "07", Aug: "08", Sep: "09", Oct: "10", Nov: "11", Dec: "12" }, u = /\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.?\d{0,3}[Z\-+]?(\d{2}:?\d{2})?/; DateFormat.format = function () { function o(e) { return a[e] || e } function i(e) { var a, r, t, n, s, o = e, i = ""; return -1 !== o.indexOf(".") && (o = (n = o.split("."))[0], i = n[n.length - 1]), 3 <= (s = o.split(":")).length ? (a = s[0], r = s[1], t = s[2].replace(/\s.+/, "").replace(/[a-z]/gi, ""), { time: o = o.replace(/\s.+/, "").replace(/[a-z]/gi, ""), hour: a, minute: r, second: t, millis: i }) : { time: "", hour: "", minute: "", second: "", millis: "" } } function D(e, a) { for (var r = a - String(e).length, t = 0; t < r; t++)e = "0" + e; return e } return { parseDate: function (e) { var a, r, t = { date: null, year: null, month: null, dayOfMonth: null, dayOfWeek: null, time: null }; if ("number" == typeof e) return this.parseDate(new Date(e)); if ("function" == typeof e.getFullYear) t.year = String(e.getFullYear()), t.month = String(e.getMonth() + 1), t.dayOfMonth = String(e.getDate()), t.time = i(e.toTimeString() + "." + e.getMilliseconds()); else if (-1 != e.search(u)) a = e.split(/[T\+-]/), t.year = a[0], t.month = a[1], t.dayOfMonth = a[2], t.time = i(a[3].split(".")[0]); else switch (6 === (a = e.split(" ")).length && isNaN(a[5]) && (a[a.length] = "()"), a.length) { case 6: t.year = a[5], t.month = o(a[1]), t.dayOfMonth = a[2], t.time = i(a[3]); break; case 2: r = a[0].split("-"), t.year = r[0], t.month = r[1], t.dayOfMonth = r[2], t.time = i(a[1]); break; case 7: case 9: case 10: t.year = a[3]; var n = parseInt(a[1]), s = parseInt(a[2]); n && !s ? (t.month = o(a[2]), t.dayOfMonth = a[1]) : (t.month = o(a[1]), t.dayOfMonth = a[2]), t.time = i(a[4]); break; case 1: r = a[0].split(""), t.year = r[0] + r[1] + r[2] + r[3], t.month = r[5] + r[6], t.dayOfMonth = r[8] + r[9], t.time = i(r[13] + r[14] + r[15] + r[16] + r[17] + r[18] + r[19] + r[20]); break; default: return null }return t.time ? t.date = new Date(t.year, t.month - 1, t.dayOfMonth, t.time.hour, t.time.minute, t.time.second, t.time.millis) : t.date = new Date(t.year, t.month - 1, t.dayOfMonth), t.dayOfWeek = String(t.date.getDay()), t }, date: function (a, e) { try { var r = this.parseDate(a); if (null === r) return a; for (var t, n = r.year, s = r.month, o = r.dayOfMonth, i = r.dayOfWeek, u = r.time, c = "", h = "", l = "", m = !1, y = 0; y < e.length; y++) { var d = e.charAt(y), f = e.charAt(y + 1); if (m) "'" == d ? (h += "" === c ? "'" : c, c = "", m = !1) : c += d; else switch (l = "", c += d) { case "ddd": h += (S = i, I[parseInt(S, 10)] || S), c = ""; break; case "dd": if ("d" === f) break; h += D(o, 2), c = ""; break; case "d": if ("d" === f) break; h += parseInt(o, 10), c = ""; break; case "D": h += o = 1 == o || 21 == o || 31 == o ? parseInt(o, 10) + "st" : 2 == o || 22 == o ? parseInt(o, 10) + "nd" : 3 == o || 23 == o ? parseInt(o, 10) + "rd" : parseInt(o, 10) + "th", c = ""; break; case "MMMM": h += (M = s, void 0, g = parseInt(M, 10) - 1, w[g] || M), c = ""; break; case "MMM": if ("M" === f) break; h += (k = s, void 0, p = parseInt(k, 10) - 1, v[p] || k), c = ""; break; case "MM": if ("M" === f) break; h += D(s, 2), c = ""; break; case "M": if ("M" === f) break; h += parseInt(s, 10), c = ""; break; case "y": case "yyy": if ("y" === f) break; h += c, c = ""; break; case "yy": if ("y" === f) break; h += String(n).slice(-2), c = ""; break; case "yyyy": h += n, c = ""; break; case "HH": h += D(u.hour, 2), c = ""; break; case "H": if ("H" === f) break; h += parseInt(u.hour, 10), c = ""; break; case "hh": h += D(t = 0 === parseInt(u.hour, 10) ? 12 : u.hour < 13 ? u.hour : u.hour - 12, 2), c = ""; break; case "h": if ("h" === f) break; t = 0 === parseInt(u.hour, 10) ? 12 : u.hour < 13 ? u.hour : u.hour - 12, h += parseInt(t, 10), c = ""; break; case "mm": h += D(u.minute, 2), c = ""; break; case "m": if ("m" === f) break; h += parseInt(u.minute, 10), c = ""; break; case "ss": h += D(u.second.substring(0, 2), 2), c = ""; break; case "s": if ("s" === f) break; h += parseInt(u.second, 10), c = ""; break; case "S": case "SS": if ("S" === f) break; h += c, c = ""; break; case "SSS": h += D(u.millis.substring(0, 3), 3), c = ""; break; case "a": h += 12 <= u.hour ? "PM" : "AM", c = ""; break; case "p": h += 12 <= u.hour ? "p.m." : "a.m.", c = ""; break; case "E": h += (b = i, O[parseInt(b, 10)] || b), c = ""; break; case "'": c = "", m = !0; break; default: h += d, c = "" } } return h += l } catch (e) { return console && console.log && console.log(e), a } var b, k, p, M, g, S }, prettyDate: function (e) { var a, r, t, n, s; if ("string" != typeof e && "number" != typeof e || (a = new Date(e)), "object" == typeof e && (a = new Date(e.toString())), r = ((new Date).getTime() - a.getTime()) / 1e3, t = Math.abs(r), n = Math.floor(t / 86400), !isNaN(n)) return s = r < 0 ? "from now" : "ago", t < 60 ? 0 <= r ? "just now" : "in a moment" : t < 120 ? "1 minute " + s : t < 3600 ? Math.floor(t / 60) + " minutes " + s : t < 7200 ? "1 hour " + s : t < 86400 ? Math.floor(t / 3600) + " hours " + s : 1 === n ? 0 <= r ? "Yesterday" : "Tomorrow" : n < 7 ? n + " days " + s : 7 === n ? "1 week " + s : n < 31 ? Math.ceil(n / 7) + " weeks " + s : "more than 5 weeks " + s }, toBrowserTimeZone: function (e, a) { return this.date(new Date(e), a || "MM/dd/yyyy HH:mm:ss") } } }() }(), jQuery.format = DateFormat.format;

        // library functions
        var getSeason = function (date) {
            // javascript Date.getMonth() is STUPID, and returns the 0-based index of the month rather than the month,
            // so checking for "Is it April?" means checking if getMonth() == 3
            // NOTE: If we're in April 2020, the season is actually part of the May 2020 season, so "202005". Otherwise it's
            // just yyyyMM for whatever month you're in.
            if (date.getUTCMonth() == 3 && date.getUTCFullYear() == 2020) {
                date.setMonth(4);
            }
            var currentSeason = jQuery.format.date(date, "yyyyMM");
            return currentSeason;
        };

        var hashParams = null;
        var hashParam = function (name) {
            if (!hashParams) {
                hashParams = {};
                document.location.hash.substring(1).split("&").forEach(function (paramStr) {
                    var kvp = paramStr.split("=");
                    hashParams[kvp[0]] = kvp[1];
                });
            }
            return hashParams[name];
        };

        var param = function (name) {
            if (name = (new RegExp('[?&]' + encodeURIComponent(name) + '=([^&]*)')).exec(location.search))
                return decodeURIComponent(name[1]);
        };

        // constants
        const API_URL = "http://sotledger.azurewebsites.net/api/";
        const USER_URL = API_URL + "user/";
        const LEDGER_URL = API_URL + "ledger";
        const FACTIONS = {
            "af": {
                name: "Athena's Fortune",
                rgb: d3.rgb("#91E6CB")
            },
            "gh": {
                name: "Gold Hoarders",
                rgb: d3.rgb("#C3922E")
            },
            "ma": {
                name: "Merchant Alliance",
                rgb: d3.rgb("#9599B3")
            },
            "os": {
                name: "Order of Souls",
                rgb: d3.rgb("#764B74")
            },
            "rb": {
                name: "Reapers Bones",
                rgb: d3.rgb("#B13314")
            }
        };

        // global variables
        var seasonData = { y: "Top Quartile Cut-offs", factions: [], dates: [] };
        var userData = {};
        var season = hashParam("season") || getSeason(new Date());
        var users = [];
        if (hashParam("users"))
            users = hashParam("users").split(",");

        var refreshData = function () {
            $.ajax({
                async: true,
                type: "GET",
                url: LEDGER_URL + "?season=" + season,
                headers: {
                    Accept: "application/json"
                },
                success: function (data) {
                    seasonData.minScore = Number.MAX_VALUE;
                    seasonData.maxScore = 0;
                    seasonData.factions = [];
                    let rowKeys = Object.keys(data.entries).sort();
                    Object.keys(FACTIONS).forEach(function (facKey) {
                        let facData = {
                            name: FACTIONS[facKey].name,
                            rgb: FACTIONS[facKey].rgb,
                            values: []
                        };
                        rowKeys.forEach(function (rowKey) {
                            let val = data.entries[rowKey][facKey + "_0_lo_score"];
                            if (val < seasonData.minScore) seasonData.minScore = val;
                            if (val > seasonData.maxScore) seasonData.maxScore = val;
                            facData.values.push(val);
                        });
                        seasonData.factions.push(facData);
                    });

                    seasonData.dates = rowKeys.map(d3.timeParse("faction-%Y%m%d-%H"));

                    console.log(seasonData);
                    chart();
                }
            });
        };

        var refreshUserData = function () {
            users.forEach(function (user) {
                if (user) {
                    $.ajax({
                        async: true,
                        type: "GET",
                        url: USER_URL + user + "?season=" + season,
                        headers: {
                            Accept: "application/json"
                        },
                        success: function (data) {
                            var keys = Object.keys(data.entries).sort();
                            var last = data.entries[keys[keys.length - 1]];
                            userData[user] = {};
                            Object.keys(FACTIONS).forEach(function (facKey) {
                                userData[user][facKey] = last[facKey + "_score"];
                            });
                            console.log(userData);
                        }
                    });
                }
            });
        };



        var margin = { top: 30, right: 20, bottom: 30, left: 100 },
            width = 900 - margin.left - margin.right,
            height = 600 - margin.top - margin.bottom;

        var x = d3.scaleTime().range([0, width]);
        var y = d3.scaleLinear().range([height, 0]);

        var xAxis = d3.axisBottom().scale(x).ticks(5);

        var yAxis = d3.axisLeft().scale(y).ticks(5);

        var scoreline = d3.line()
            .x(function (d, i) { return x(seasonData.dates[i]); })
            .y(function (d) { return y(d); });

        var svg = null;

        var chart = function () {
            x.domain(d3.extent(seasonData.dates, function (d) { return d; }));
            y.domain([seasonData.minScore, seasonData.maxScore]);

            seasonData.factions.forEach(function (faction) {
                svg.append("path")
                    .attr("class", "line")
                    .style("stroke", faction.rgb)
                    .attr("d", scoreline(faction.values));
            });

            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis);
            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis);

        };

        $(document).ready(function () {
            svg = d3.select("body")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
            refreshData();
            refreshUserData();
        });
    </script>
</head>
<body></body>
</html>